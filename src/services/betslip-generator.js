/**
 * Betslip Generator - Creates professional betslip images/documents
 */

import { Logger } from "../utils/logger.js";

const logger = new Logger("BetslipGenerator");

class BetslipGenerator {
  /**
   * Generate betslip as formatted text/image data
   */
  static formatBetslipAsImage(slip, user, currency = "KES") {
    try {
      const matches = slip.matches || [];
      const totalOdds = slip.totalOdds || 1;

      // Create professional betslip text representation
      let betslip = `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ðŸŽ¯ BETRIX BETSLIP                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“‹ SLIP ID: ${slip.id || "NEW"}
ðŸ‘¤ PLAYER: ${user.name || "Anonymous"}
ðŸ“… DATE: ${new Date().toLocaleDateString()}
â° TIME: ${new Date().toLocaleTimeString()}

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    MATCHES (${matches.length})                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

`;

      matches.forEach((m, i) => {
        betslip += `${i + 1}. ${m.team}\n`;
        betslip += `   Match: ${m.matchId || "TBA"}\n`;
        betslip += `   Prediction: ${m.prediction}\n`;
        betslip += `   Odds: ${m.odds}\n`;
        betslip += `\n`;
      });

      betslip += `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      SUMMARY                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Total Matches: ${matches.length}
Type: PARLAY
Total Odds: ${totalOdds}
Bet Type: ${matches.length === 1 ? "SINGLE" : "MULTI"}

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   STAKE CALCULATOR                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Stake 100 ${currency}  â†’ Win: ${(100 * totalOdds).toFixed(2)} ${currency}
Stake 500 ${currency}  â†’ Win: ${(500 * totalOdds).toFixed(2)} ${currency}
Stake 1000 ${currency} â†’ Win: ${(1000 * totalOdds).toFixed(2)} ${currency}

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          ODDS BREAKDOWN & RECOMMENDATIONS            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Expected Value (EV): ${(totalOdds - 1).toFixed(2)}
Risk Level: ${this.calculateRiskLevel(totalOdds)}
Confidence: ${this.calculateConfidence(matches)}%

âœ… THIS BETSLIP IS RECOMMENDED
   â€¢ All matches have strong fundamentals
   â€¢ Odds offer good value
   â€¢ Risk/reward ratio favorable

âš ï¸  RISK MANAGEMENT
   â€¢ Only bet what you can afford to lose
   â€¢ Recommended unit size: 2-3% of bankroll
   â€¢ Use the stake calculator above

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              Generated by BETRIX AI
            Professional Sports Analysis
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`;

      return betslip;
    } catch (err) {
      logger.error("Format betslip failed", err);
      return "Error generating betslip";
    }
  }

  /**
   * Generate SVG betslip (can be converted to image)
   */
  static generateBetslipSVG(slip, user) {
    const matches = slip.matches || [];
    const totalOdds = slip.totalOdds || 1;

    const matchesHTML = matches
      .map(
        (m, i) => `
        <text x="20" y="${200 + i * 60}" font-size="14" fill="#333">
          ${i + 1}. ${m.team} - ${m.prediction} @ ${m.odds}
        </text>
      `,
      )
      .join("");

    const svg = `
<svg width="600" height="${300 + matches.length * 60}" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      body { font-family: Arial, sans-serif; }
      .header { font-size: 24px; font-weight: bold; fill: #2c3e50; }
      .label { font-size: 12px; fill: #7f8c8d; }
      .value { font-size: 16px; fill: #2c3e50; font-weight: bold; }
    </style>
  </defs>
  
  <!-- Background -->
  <rect width="600" height="${300 + matches.length * 60}" fill="#f8f9fa" stroke="#ddd" stroke-width="2" rx="10"/>
  
  <!-- Header -->
  <text x="20" y="40" class="header">ðŸŽ¯ BETRIX BETSLIP</text>
  <text x="20" y="70" class="label">Player: ${user.name}</text>
  <text x="20" y="90" class="label">Date: ${new Date().toLocaleDateString()}</text>
  
  <!-- Matches -->
  <text x="20" y="130" class="label">MATCHES:</text>
  ${matchesHTML}
  
  <!-- Summary -->
  <text x="20" y="${220 + matches.length * 60}" class="value">Total Odds: ${totalOdds}</text>
  <text x="20" y="${250 + matches.length * 60}" class="value">Confidence: ${this.calculateConfidence(matches)}%</text>
  
  <!-- Footer -->
  <text x="20" y="${280 + matches.length * 60}" class="label">Generated by BETRIX AI</text>
</svg>
    `;

    return svg;
  }

  /**
   * Calculate risk level
   */
  static calculateRiskLevel(odds) {
    if (odds > 5) return "ðŸ”´ HIGH RISK";
    if (odds > 3) return "ðŸŸ  MEDIUM-HIGH RISK";
    if (odds > 2) return "ðŸŸ¡ MEDIUM RISK";
    return "ðŸŸ¢ LOW-MEDIUM RISK";
  }

  /**
   * Calculate confidence percentage
   */
  static calculateConfidence(matches) {
    if (!matches || matches.length === 0) return 50;
    // Simple average of match confidence if available
    const confidences = matches.map((m) => m.confidence || 70);
    return Math.round(
      confidences.reduce((a, b) => a + b, 0) / confidences.length,
    );
  }

  /**
   * Format for WhatsApp/Telegram sharing
   */
  static formatForSharing(slip, user, currency) {
    const betslip = this.formatBetslipAsImage(slip, user, currency);

    return `
ðŸ“‹ BETRIX BETSLIP
${betslip}

ðŸ”— Share this betslip: https://betrix.app/slip/${slip.id}
ðŸ’¬ Questions? Chat with BETRIX!
    `;
  }
}

export { BetslipGenerator };
