/* --- TELEGRAM CHAT ID EXTRACTOR (injected) --- */
function resolveTelegramChatId(update){
  if (!update || typeof update !== "object") return undefined;
  if (update.message && update.message.chat && update.message.chat.id) return update.message.chat.id;
  if (update.edited_message && update.edited_message.chat && update.edited_message.chat.id) return update.edited_message.chat.id;
  if (update.callback_query && update.callback_query.message && update.callback_query.message.chat && update.callback_query.message.chat.id) return update.callback_query.message.chat.id;
  if (update.channel_post && update.channel_post.chat && update.channel_post.chat.id) return update.channel_post.chat.id;
  if (update.edited_channel_post && update.edited_channel_post.chat && update.edited_channel_post.chat.id) return update.edited_channel_post.chat.id;
  try {
    const stack = [update];
    while (stack.length){
      const obj = stack.pop();
      if (!obj || typeof obj !== "object") continue;
      if (obj.chat && obj.chat.id && (typeof obj.chat.id === 'number' || /^\d+$/.test(obj.chat.id))) return obj.chat.id;
      for (const k of Object.keys(obj)) {
        if (obj[k] && typeof obj[k] === "object") stack.push(obj[k]);
      }
    }
  } catch (e){}
  return undefined;
}

/* helper to log raw update and resolved chat id */
function logTelegramResolvedInfo(prefix, update){
  try {
    const chatId = resolveTelegramChatId(update);
    console.log(prefix + " TELEGRAM_RAW_UPDATE " + JSON.stringify(update));
    console.log(prefix + " TELEGRAM_RESOLVED_CHAT_ID " + (typeof chatId === 'undefined' ? 'undefined' : chatId));
    return chatId;
  } catch(e){
    console.log(prefix + " TELEGRAM_RESOLVE_ERROR " + (e && e.stack ? e.stack : String(e)));
    return undefined;
  }
}
/* --- end injector --- */

/* USAGE:
   Inside your route handler where you receive the incoming update (e.g., req.body):
     const raw = req.body;
     const chatId = logTelegramResolvedInfo('INCOMING', raw);
     // include chatId (if present) when enqueuing job so downstream handlers have it:
     // enqueue({ jobId, payload: raw, chatId });
*/

